default_platform(:ios)

platform :ios do
  desc "Build and upload iOS build to TestFlight"
  lane :beta do
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY"],
      is_key_content_base64: true
    )

    sh("flutter", "pub", "get")
    sh("flutter", "build", "ipa", "--release", "--export-options-plist=ios/ExportOptions.plist")

    upload_to_testflight(
      api_key: api_key,
      ipa: "build/ios/ipa/Runner.ipa",
      skip_waiting_for_build_processing: true
    )
  end
end

platform :android do
  desc "Build and upload Android bundle to Google Play Internal track"
  lane :internal do
    sh("flutter", "pub", "get")
    sh("flutter", "build", "appbundle", "--release")

    upload_to_play_store(
      track: "internal",
      aab: "build/app/outputs/bundle/release/app-release.aab",
      json_key_data: ENV["GOOGLE_PLAY_SERVICE_ACCOUNT_JSON"]
    )
  end
end
